[id='dmn-execution-business-process']
= Executing a DMN service using the Business Process

Business processes interact with DMN services by identification of the demanded
DMN service and mapping business data to DMN inputs and back from DMN to business data. We will demonstrate such
interaction on sample *TrainStation* project.

We will use just one data object *Train*. This data object will have 3 fields. The fields *departureStation* and
*destinationStation* describe the route of the train. The third field *railNumber* represents the rail in the
station, where the train will stop at.

.Train.java
[source,java,align="center"]
----
public class Train {

     private String departureStation;

     private String destinationStation;

     private BigDecimal railNumber;

     // getters and setters omitted
}
----

Now we will describe routing logic using a DMN model *Compute Rail*. The DMN model will have one input node *Train*
and one decision node *Rail*. The first node will represent the incoming train and the second one the rail number
where the train should stop at.

image::dmn/dmn-execution-graph.png[align="center",title="Compute Rail.dmn"]

As this is demo, we will specify the routing just for some trains. The decision table will return first appropriate
rail of the station for the incoming train. If no appropriate rail is available, then null value is returned.

image::dmn/dmn-execution-expression.png[align="center",title="Rail - Decision Table expression"]

To complete the DMN model, we need to set data type of the node *Train* to be *tTrain*. The data type as shown below
needs to be created on *Data Types* tab.

image::dmn/dmn-execution-data-type.png[align="center",title="Data Type tTrain"]

Now we are ready to use our DMN model in the business process.

image::dmn/dmn-execution-business-process.png[align="center",title="Accept Train.bpmn"]

The *Route To Rail* node will invoke our DMN service identified by the listed properties below. Please notice
the *Namespace* value is always unique and you need to find it in your *Compute Rail* model.

* *Rule Language* - set as *DMN*
* *Namespace*
* *Decision Name* - Set as *Rail*
* *Model Name* - Set as *Compute Rail*

Next we have to provide mapping between process data and DMN service inputs. To be able to do such mapping we have to
 create one process variable *train* and set its type as *Train* we created in the very beginning.

image::dmn/dmn-execution-io-mapping.png[align="center",title="Route To Rail data mapping"]

When the *Route To Rail* is finished, we will store the rail, place the snippet into *On Exit Script*:

[source,java]
----
train.setRailNumber(rail);
----

The business process will finish in error state, if the rail number was not computed.

image::dmn/dmn-execution-negative-condition.png[align="center",title="No Appropriate Rail condition"]

On the contrary, if the rail number was computed, we will proceed to *Accept Train* node.

image::dmn/dmn-execution-positive-condition.png[align="center",title="Accept Train condition"]

The *Accept Train* node will just print message about the train route and current rail. However it could be replaced
with more complex node. Paste the snippet into *Accept Train* script field.

[source,java]
----
com.myspace.trainstation.Train t =
    (com.myspace.trainstation.Train) kcontext.getVariable("train");
System.out.println("Train from: " + t.getDepartureStation() +
                   ", to: " + t.getDestinationStation() +
                   ",  is on rail: " + t.getRailNumber());
----

Now we can deploy the *TrainStation* project and run the corresponding process definition. Fill route from Zagreb to
Belgrade.

image::dmn/dmn-execution-process-instance-form.png[align="center",title="Process Instance starting form"]


After successful execution a log message should appear in the server log:
....
Train from: Zagreb, to: Belgrade,  is on rail: 1
....

