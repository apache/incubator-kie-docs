= Pricing Rule (Decision Table) Example


The Pricing Rule example demonstrates the use of a decision table for calculating the retail cost of an insurance policy. Decision tables are in spreadsheet format and can be either Microsoft Excel (.xls) or .ods format.
The purpose of this example is to provide a set of business rules to calculate the base price and a discount for a car driver applying for a specific policy type.
The driver's age, history and the policy type all contribute to calculate the basic premium and an additional rules calculate potential discounts the driver might be eligible for.

[source]
----
Name: Example Policy Pricing
Main class: org.drools.examples.decisiontable.PricingRuleDTExample
Module: drools-examples
Type: Java application
Rules file: ExamplePolicyPricing.xls
Objective: Demonstrate spreadsheet-based decision tables.
----

== Executing the example


Open the file [path]_PricingRuleDTExample.java_
 and  run it as a Java application.
When executed this produces:

[source]
----
Cheapest possible
BASE PRICE IS: 120
DISCOUNT IS: 20
----


The code to execute the example follows the typical execution pattern. The rules are loaded, the facts are inserted and a Stateless Session is created.
What is different is how the rules are added and maintained.

== Executing the Decision Table from DRL rules

The Policy Pricing example utilizes [path]_ExamplePolicyPricing.xls_ which is loaded into rules engine through the use of templates and the DRL rules. The spreadsheet has two different Decision Tables contained the first tab within it: "Pricing bracket" and "Discounts". The decision tables are executed through the DRL files, BasePricing.drt and PromotionalPricing.drt. These rules will reference the Decision Tables through their template parameter. Important to note with this is that only the first tab of a spreadsheet can be used for decision table creation, but multiple can be within a single sheet. 

The rules are executed through the kmodule.xml reference of the Knowledge Session: `DTableWithTemplateKB` which specifically mentions this spreadsheet and is required for successful execution of the rules. Seen below is the section of the kmodule.xml that is required for the execution of the rules and spreadsheet to work successfully.

[source,xml]
--
    <kbase name="DecisionTableKB" packages="org.drools.examples.decisiontable">
        <ksession name="DecisionTableKS" type="stateless"/>
    </kbase>

    <kbase name="DTableWithTemplateKB" packages="org.drools.examples.decisiontable-template">
        <ruleTemplate dtable="org/drools/examples/decisiontable-template/ExamplePolicyPricingTemplateData.xls"
                      template="org/drools/examples/decisiontable-template/BasePricing.drt"
                      row="3" col="3"/>
        <ruleTemplate dtable="org/drools/examples/decisiontable-template/ExamplePolicyPricingTemplateData.xls"
                      template="org/drools/examples/decisiontable-template/PromotionalPricing.drt"
                      row="18" col="3"/>
        <ksession name="DTableWithTemplateKS"/>
    </kbase>

--

There are two fact types used in this example, `Driver` and `Policy`.
Both are used with their default values set in their respective Java applications - `Driver.java` and `Policy.java`
The `Driver` is 30 years old, has had no prior claims and currently has a risk profile of `LOW`.
The `Policy` being applied for is `COMPREHENSIVE`, and it has not yet been approved.

== The decision table and its format

In any decision table, each row is considered a different rule, and each column is a condition or an action. Each row is evaluated in a decision table unless the agenda is cleared upon execution. This is important to note if your scenario would successfully execute two different rules as both would fire and potentially alter the expected results.

.Decision table configuration
image::Examples/PricingExample/DT_Config.png[align="center"]

=== Base price rule
The base price rule is the first rule that you executed in the execution of the business rules. This rule evaluates the age, risk profile, number of claims and policy type of the driver and produces the base price of the policy based on these conditions.

==== Decision table headers
Referring to the spreadsheet shown above, the `RuleSet` declaration, which provides the package name (`org.drools.examples.decisiontable').
There are also other optional items you can have here, such as `Variables` for global variables, and `Imports` for importing classes.
In this case, the namespace of the rules is the same as the fact classes you are using, so you can omit it.

Moving further down, you can see the `RuleTable` declaration.
The name after this `Pricing bracket` is used as the prefix for all the generated rules. 
Below that, you have `CONDITION` or `ACTION`, indicating the purpose of the column. This determines if the column is part of the condition to be evaluated or the consequence of the rule that will be generated. A more detailed explanation of Driver and Policy found within the decision table are found below.

==== Driver
The attributes of the driver are defined in Row 8 containing the columns Age Bracket, Location risk profile, Number of prior claims.

Age Bracket (age):: 
The column for age has a definition for the condition `age >=$1, age<=$2` which defines the condition boundaries for the driver's age. This condition column highlights the use of `$1 and $2`, which when putting the data in the spreadsheet is comma delimited. These can be either written as `18,24` or `18, 24` and both formats will work in the execution of the business rules.

Location risk profile (locationRiskProfile)::
The risk profile is a string that the example program passes always as LOW but could be changed to reflect MED or HIGH. 

Number of prior claims (priorClaims)::
The number of claims is defined as an integer that the condition column must exactly equal to trigger the action, there is no range on these, just exact matches.


==== Policy
The policy of the decision table is utilized in both the conditions and the actions of the rule. This is highlighted through the use of the policy type of coverage the driver is selecting and then the prices that are set based on successful execution of the rules. 

Policy type applying for (type)::
The policy type is a condition that is passed as a string that defines the type of coverage ("COMPREHENSIVE", "FIRE_THEFT", "THIRD_PARTY"). 

Base $ AUD (basePrice)::
The `basePrice` is defined as an `ACTION` which sets the price through the usage of `policy.setBasePrice($param);` based on the spreadsheet cells corresponding to this value. The Drools file,  when it gets to the then portion of the rule will execute this action statement on the true conditions matching the facts and set the base price to the corresponding value. 

Record Reason (output to System.out)::
When the rule successfully executes, the action here is to output a message to the System.out console reflecting which rule fired. This is then later captured in the application and printed. 

.Base price calculation
image::Examples/PricingExample/DT_Table1.png[align="center"]


In the preceding spreadsheet section, there are broad category groups, indicated by the comment in the leftmost column. This column can be used for highlighting similarities in rules, but does not affect the execution of the rules.

As learned from the facts for your drivers and their policy, this should match row number 18, as they have no prior accidents, and are 30 years old.
This gives a base price of 120.

=== Discount calculation rule
The discount calculation focuses is evaluating a second decision table found in _ExamplePolicyPricing.xls_, which has the following breakdown of what will be evaluated against the driver's age, number of prior claims and their policy type to generate a discount on the price of the insurance policy. 

.Discount calculation
image::Examples/PricingExample/DT_Table2.png[align="center"]


The above section contains the conditions for the discount that the driver might be eligible for. Similar to the base price calculation above, the rule evaluates the `Age`, `Number of Prior Claims` of the driver and the 
The discount results from the `Age` bracket, the number of prior claims, and the policy type.
In our case, the driver is 30, with no prior claims, and is applying for a `COMPREHENSIVE` policy, which means the driver is given a discount of 20%. Note that this is actually a separate table, but in the same worksheet, so that different templates apply. It is important to note that decision tables generate rules. This means they aren't simply top-down logic, but more a means to capture data resulting in rules. This is a subtle difference that may confuse some. The evaluation of the rules is not necessarily in the given order, since all the normal mechanics of the {ENGINE} still apply. This also means that a spreadsheet can have multiple tables on a tab covering different rules. An important thing to note with this is that each spreadsheet can have multiple decision tables on a single tab, but the engine will only evaluate the first tab. Depending on the requirement, multiple decision tables could be in one spreadsheet file or multiple different files depending on the needs of maintaining said spreadsheet(s).


=== Alternate method of loading the decision table spreadsheet
An alternative method you can use for loading the decision tables is to utilize the following code snippet that would load the same spreadsheet for decision table evaluation.
[source,java]
----
DecisionTableConfiguration dtableconfiguration =
    KnowledgeBuilderFactory.newDecisionTableConfiguration();
        dtableconfiguration.setInputType( DecisionTableInputType.XLS );

        KnowledgeBuilder kbuilder = KnowledgeBuilderFactory.newKnowledgeBuilder();

        Resource xlsRes = ResourceFactory.newClassPathResource( "ExamplePolicyPricing.xls",
                                                                getClass() );
        kbuilder.add( xlsRes,
                      ResourceType.DTABLE,
                      dtableconfiguration );
----                      
                      
Note the use of the `DecisionTableConfiguration` object.
Its input type is set to your spreadsheet file, e.g. _DecisionTableInputType.xls_.
