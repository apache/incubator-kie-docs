[[_wb.sshKeyStore]]
= SSH KeyStore

This section introduces the Workbench SSH KeyStore, gives an overview of it and adds a guide for platform user
explaining how to use it to register and use it's SSH Public Keys.

== Introduction

The Workbench provides a SSH KeyStore Service in order to provide a proper SSH authentication for users.

It provides a configurable Default SSH KeyStore, extensible API's to allow using custom implementations, support for
multiple SSH Public Keys Formats and a new UI available on the Admin Page to allow users registering their SSH Public Keys.

=== The Default SSH KeyStore

The Default SSH KeyStore packed on the Workbench provides a file based storage mechanism to keep the user SSH Public Keys.

By default it uses the the Workbench ``.security`` folder as a root path, is it possible to use a custom storage path by
setting a the ``appformer.ssh.keys.storage.folder`` property pointing to a different folder.

The SSH Public Keys are stored in the following folder structure ``{securityFolderPath}/pkeys/{userName}/`.

Each SSH Public Key consists as a pair of files on the storage folder:

* **{keyId}.pub**: a file containing the SSH Public Key content. The fileName determines the logic Key Id on the system,
so it is recommended not to modify the fileName during the runtime. Example:
[source]
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDmak4Wu23RZ6XmN94bOsqecZxuTa4RRhhQmHmTZjMB7HM57/90u/B/gB/GhsPEu1nAXL0npY56tT/MPQ8vRm2C2W9A7CzN5+z5yyL3W01YZy3kzslk77CjULjfhrcfQSL3b2sPG5jv5E5/nyC/swSytucwT/PE7aXTS9H6cHIKUdYPzIt94SHoBxWRIK7PJi9d+eLB+hmDzvbVa1ezu5a8yu2kcHi6NxxfI5iRj2rsceDTp0imC1jMoC6ZDfBvZSxL9FXTMwFdNnmTlJveBtv9nAbnAvIWlilS0VOkdj1s3GxBxeZYAcKbcsK9sJzusptk5dxGsG2Z8vInaglN6OaOQ7b7tcomzCYYwviGQ9gRX8sGsVrw39gsDIGYP2tA4bRr7ecHnlNg1b0HCchA5+QCDk4Hbz1UrnHmPA2Lg9c3WGm2qedvQdVJXuS3mlwYOqL40aXPs6890PvFJUlpiVSznF50djPnwsMxJZEf1HdTXgZD1Bh54ogZf7czyUNfkNkE69yJDbTHjpQd0cKUQnu9tVxqmBzhX31yF4VcsMeADcf2Z8wlA3n4LZnC/GwonYlq5+G93zJpFOkPhme8c2XuPuCXF795lsxyJ8SB/AlwPJAhEtm0y0s0l1l4eWqxsDxkBOgN+ivU0czrVMssHJEJb4o0FLf7iHhOW56/iMdD9w== userName

* **.{keyId}.pub.meta**: a file containing the key metadata in JSON format. If a key has no meta data a new one will be
dynamically generated. Example:
[source, json]
{
    "name":"Key",
    "creationDate":"Oct 10, 2018 10:10:50 PM",
    "lastTimeUsed":"Oct 11, 2018 12:11:23 PM"
}

=== Using a Custom SSH KeyStore

Although the platform a Default SSH KeyStore it is possible to extend and customize the SSH KeyStore to meet more
specific requirements.

Use the system property ``appformer.ssh.keystore`` to specify the Java className of the service to use. If the property
doesn't exist or it contains a wrong value the Default SSH KeyStore will be loaded.

[NOTE]
====
To create a custom implementation of the SSH KeyStore your Java Class must implement the class ``org.uberfire.ssh.service.backend.keystore.SSHKeyStore``
defined on the ``uberfire-ssh-api`` module
====

== Using the SSH KeyStore

This section describes how a user should use the SSH KeyStore to register his own keys and how to use them.

=== The SSH KeyStore UI

The SSH KeyStore provides an intuitive to allow users to manage their SSH Public on the system. It is accessible from
the Admin Page by using the SSH Keys menu option.

.SSH Keys Menu Option on Admin Page
image::Workbench/SSHKeyStore/ssh-keystore-menu.png[align="center"]

Once pressed the SSH Keys menu option the SSH Keys Editor will open. It displays a table showing the user SSH Keys and
provides access to the main action buttons

* **Add SSH Key**: Used to add a SSH Public Key for the user.
+
.Adding new SSH Public Key
image::Workbench/SSHKeyStore/ssh-keystore-editor-new.png[align="center"]
* **Delete SSH Key**: Used to remove an existing SSH Public Key
+
.Deleting a SSH Public Key
image::Workbench/SSHKeyStore/ssh-keystore-editor-delete.png[align="center"]

.SSH KeyStore UI
image::Workbench/SSHKeyStore/ssh-keystore-editor.png[align="center"]

=== Adding SSH Keys

This section will guide a user step by step how to add a SSH Public Key to the SSH KeyStore.

==== Creating the SSH Key on your computer

1. Open a terminal on your computer

2. Run the ``ssh-keygen`` command to create the key as follows.
[source,shell]
$ ssh-keygen -t rsa -b 4096 -C "<your_user_login_here>"
+
[NOTE]
====
The SSH Keys format supported by the Keystore are 'ssh-rsa', 'ssh-dss', 'ecdsa-sha2-nistp256', 'ecdsa-sha2-nistp384'
or 'ecdsa-sha2-nistp521'.
====

3. When prompted, press Enter and accept the default key file location.
[source,shell]
Enter a file in which to save the key (/home/<your_login_here>/.ssh/id_rsa): [Press enter]

4. Type your passphrasse you want to use when asked.
[source,shell]
Enter passphrase (empty for no passphrase): [Type a passphrase]
Enter same passphrase again: [Type passphrase again]

5. Start the ``ssh-agent``
[source,shell]
$ eval "$(ssh-agent -s)"
Agent pid <any-number-here>

6. Add the new SSH private key to the ssh-agent. If you used a different key name replace ``id_rsa`` with your key name
[source,shell]
$ ssh-add ~/.ssh/id_rsa

==== Registering your SSH Public Key on the SSH KeyStore

1. Log in to the Workbench and click the gear icon next to your login to open the *Admin* page.
+
.Accessing the Admin Page
image::Workbench/SSHKeyStore/ssh-keystore-editor-gear.png[align="center"]

2. Open the SSH KeyStore UI by Presing the SSH Keys Menu Option
+
.SSH Keys Menu Option on Admin Page
image::Workbench/SSHKeyStore/ssh-keystore-menu.png[align="center"]
+
.SSH KeysStore UI Without keys
image::Workbench/SSHKeyStore/ssh-keystore-editor-empty.png[align="center"]

3. Copy the contents of your SSH Public key into the clipboard. Use cat command to show your key content (again, if you
used a different key name replace ``id_rsa`` with your key name) and copy it
[source,shell]
$ cat ~/.ssh/id_rsa.pub

4. On the SSH KeyStore UI press the ``Add SSH Key`` button to open the New SSH Public Key modal and fill the form with a
specifying a ``Name`` and copying the key content into the ``Key`` field. Finally press the ``Add SSH Key`` button on the
modal to add register the key.
+
.Adding new SSH Public Key
image::Workbench/SSHKeyStore/ssh-keystore-editor-new.png[align="center"]
+
[NOTE]
====
* ``Name`` field is cannot be empty, this field defines a logic name for the user to identify the key on the SSH Public Keys table.
* ``Key`` must be a valid SSH Public key, so it cannot be empty and the key format must be supported by the platform.
====