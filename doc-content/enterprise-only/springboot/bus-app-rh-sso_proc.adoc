[id='bus-app-rh-sso_{context}']
= Configuring the business application with Red Hat Single-On

You can use Red Hat Single Sign-On (RH SSO) to enable single sign-on between your services and to have a central place to configure and manage your users and roles. 

.Prerequisite
You have a `<business-application>.zip` file that you created using the http://start.jbpm.org[business applications] web site.

.Procedure
. Download and install RH-SSO. For instructions, see the https://access.redhat.com/documentation/en-us/red_hat_single_sign-on/7.2/html/getting_started_guide/[_Red Hat Single Sign-On Getting Started Guide_].
. Configure RH-SSO:
.. Either use the default master realm or create a new realm.
.. Create the `springboot-app` client and set the `AccessType` to public.
.. Set a valid redirect URI and web origin according to your local setup, for example:
+
* Valid redirect URIs: http://localhost:8090/*
* Web Origins: http://localhost:8090
.. Create realm roles that are used in the application
.. Create users used in the application and assign roles to them.
. Add the following dependencies to service project pom.xml:
+
[source, xml]
----
<dependencyManagement>
  <dependencies>
    <dependency>
      <groupId>org.RH-SSO.bom</groupId>
      <artifactId>rhsso-adapter-bom</artifactId>
      <version>${version.org.rhsso}</version>
      <type>pom</type>
      <scope>import</scope>
    </dependency>
  </dependencies>
</dependencyManagement>

  ....

<dependency>
  <groupId>org.rhsso</groupId>
  <artifactId>rhsso-spring-boot-starter</artifactId>
</dependency>
----

. Update the `application.properties` file:
+
[source, bash]
----
# rhsso security setup
rhsso.auth-server-url=http://localhost:8100/auth
rhsso.realm=master
rhsso.resource=springboot-app
rhsso.public-client=true
rhsso.principal-attribute=preferred_username
rhsso.enable-basic-auth=true
----
. Modify `DefaultWebSecurityConfig.java` to ensure that Spring Security works correctly with RH-SSO:
+
[source]
----
import org.keycloak.adapters.KeycloakConfigResolver;
import org.keycloak.adapters.springboot.KeycloakSpringBootConfigResolver;
import org.keycloak.adapters.springsecurity.authentication.KeycloakAuthenticationProvider;
import org.keycloak.adapters.springsecurity.config.KeycloakWebSecurityConfigurerAdapter;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.core.authority.mapping.SimpleAuthorityMapper;
import org.springframework.security.core.session.SessionRegistryImpl;
import org.springframework.security.web.authentication.session.RegisterSessionAuthenticationStrategy;
import org.springframework.security.web.authentication.session.SessionAuthenticationStrategy;

@Configuration("kieServerSecurity")
@EnableWebSecurity
public class DefaultWebSecurityConfig extends KeycloakWebSecurityConfigurerAdapter {

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        super.configure(http);
        http
        .csrf().disable()
        .authorizeRequests()
            .anyRequest().authenticated()
            .and()
        .httpBasic();
    }

    @Autowired
    public void configureGlobal(AuthenticationManagerBuilder auth) throws Exception {
        KeycloakAuthenticationProvider keycloakAuthenticationProvider = keycloakAuthenticationProvider();
        SimpleAuthorityMapper mapper = new SimpleAuthorityMapper();
        mapper.setPrefix("");
        keycloakAuthenticationProvider.setGrantedAuthoritiesMapper(mapper);
        auth.authenticationProvider(keycloakAuthenticationProvider);
    }

    @Bean
    public KeycloakConfigResolver KeycloakConfigResolver() {
       return new KeycloakSpringBootConfigResolver();
    }

    @Override
    protected SessionAuthenticationStrategy sessionAuthenticationStrategy() {
        return new RegisterSessionAuthenticationStrategy(new SessionRegistryImpl());
    }
}
----
