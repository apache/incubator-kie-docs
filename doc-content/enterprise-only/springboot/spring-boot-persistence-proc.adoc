[id='spring-boot-persistence-proc_{context}']
= Configuring plugable variable persistence

You can provide an arbitrary entity manager for configured process variable persistence in your {PRODUCT} Spring Boot application. To do this, add named beans during the object marshalling strategy resolution. This configuration defines a second entity manager factory based on a qualifier second data source. This process will not interfere with the primary data source.

.Prerequisites

* You have an existing {PRODUCT} Spring Boot project.

.Procedure

. Add the following `auditEntityManager` JavaBean to your java class:
+
[source]
----
    @Bean(name = "auditEntityManager")
    @ConditionalOnMissingBean(name = "auditEntityManager")
    public LocalContainerEntityManagerFactoryBean entityManagerFactory(@Qualifier("jpaAuditDataSource") DataSource dataSource, JpaProperties jpaProperties) {
        return EntityManagerFactoryHelper.create(applicationContext,
                                                 dataSource,
                                                 jpaProperties,
                                                 AUDIT_PERSISTENCE_UNIT_NAME,
                                                 PERSISTENCE_XML_LOCATION);
    }
----
The `auditEntityManager` becomes an implicit context parameter when the parameters are resolved during MVFLEX Expression Language (MVEL) evaluation.

. Add the following marshalling stragegy to the `kie-deployment-descriptor.xml` file:
+
[source]
----
 <marshalling-strategy>
    <resolver>mvel</resolver>
    <identifier>new org.drools.persistence.jpa.marshaller.JPAPlaceholderResolverStrategy(auditEntityManager)
    </identifier>
    <parameters/>
    </marshalling-strategy
----
