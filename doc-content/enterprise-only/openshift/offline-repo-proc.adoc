[id='offline-repo-proc_{context}']
:offline_onprem!:
ifeval::["{context}"=="install-on-eap"]
:offline_onprem:
endif::[]
ifeval::["{context}"=="install-on-jws"]
:offline_onprem:
endif::[]
ifeval::["{context}"=="install-on-tomcat"]
:offline_onprem:
endif::[]

= Preparing a Maven mirror repository for offline use

If your
ifdef::offline_onprem[]
{PRODUCT} deployment
endif::offline_onprem[]
ifndef::offline_onprem[]
{OPENSHIFT} environment
endif::offline_onprem[]
does not have outgoing access to the public Internet, you must prepare a Maven repository with a mirror of all the necessary artifacts and make this repository available to your environment.

[NOTE]
====
You do not need to complete this procedure if your
ifdef::offline_onprem[]
{PRODUCT} deployment
endif::offline_onprem[]
ifndef::offline_onprem[]
{OPENSHIFT} environment
endif::offline_onprem[]
is connected to the Internet.
====

.Prerequisites
* A computer that has outgoing access to the public Internet is available.

.Procedure

ifndef::offline_onprem[]
. Configure a Maven release repository to which you have write access. The repository must allow read access without authentication and your OpenShift environment must have network access to this repository.
+
You can deploy a Nexus repository manager in the OpenShift environment. For instructions about setting up Nexus on OpenShift, see https://access.redhat.com/documentation/en-us/openshift_container_platform/3.11/html/developer_guide/tutorials#nexus-setting-up-nexus[Setting up Nexus] in the {OPENSHIFT} 3.11 documentation.
ifeval::["{context}"=="openshift-operator"]
The documented procedure is applicable to {OPENSHIFT} version 4.
endif::[]
+
Use this repository as a mirror to host the publicly available Maven artifacts. You can also provide your own services in this repository in order to deploy these services on immutable
ifdef::PAM[]
servers or to deploy them on managed servers using {CENTRAL} monitoring.
endif::PAM[]
ifdef::DM[]
servers.
endif::DM[]
+
endif::offline_onprem[]
. On the computer that has an outgoing connection to the public Internet, complete the following steps:
. Navigate to the https://access.redhat.com/jbossnetwork/restricted/listSoftware.html[Software Downloads] page in the Red Hat Customer Portal (login required), and select the product and version from the drop-down options:
+
* *Product:* {PRODUCT}
* *Version:* {PRODUCT_VERSION}

.. Download and extract the *{PRODUCT_PAM} {ENTERPRISE_VERSION_LONG} Offliner Content List* (`{PRODUCT_FILE}-offliner.zip`) product deliverable file.
+
.. Extract the contents of the `{PRODUCT_FILE}-offliner.zip` file into any directory.
.. Change to the directory and enter the following command:
+
[subs="attributes,verbatim,macros"]
----
./offline-repo-builder.sh offliner.txt
----
+
This command creates the `repository` subdirectory and downloads the necessary artifacts into this subdirectory. This is the mirror repository.
+
If a message reports that some downloads have failed, run the same command again. If downloads fail again, contact Red Hat support.
ifndef::offline_onprem[]
.. Upload all artifacts from the `repository` subdirectory to the Maven mirror repository that you prepared. You can use the Maven Repository Provisioner utility, available from the https://github.com/simpligility/maven-repository-tools/tree/master/maven-repository-provisioner[Maven repository tools] Git repository, to upload the artifacts.
endif::offline_onprem[]
. If you developed services outside of {CENTRAL} and they have additional dependencies, add the dependencies to the mirror repository. If you developed the services as Maven projects, you can use the following steps to prepare these dependencies automatically. Complete the steps on the computer that has an outgoing connection to the public Internet.
.. Create a backup of the local Maven cache directory (`~/.m2/repository`) and then clear the directory.
.. Build the source of your projects using the `mvn clean install` command.
.. For every project, enter the following command to ensure that Maven downloads all runtime dependencies for all the artifacts generated by the project:
+
[subs="attributes,verbatim,macros"]
----
mvn -e -DskipTests dependency:go-offline -f /path/to/project/pom.xml --batch-mode -Djava.net.preferIPv4Stack=true
----
+
Replace `/path/to/project/pom.xml` with the path of the `pom.xml` file of the project.
+
ifndef::offline_onprem[]
.. Upload all artifacts from the local Maven cache directory (`~/.m2/repository`) to the Maven mirror repository that you prepared. You can use the Maven Repository Provisioner utility, available from the https://github.com/simpligility/maven-repository-tools/tree/master/maven-repository-provisioner[Maven repository tools] Git repository, to upload the artifacts.
endif::offline_onprem[]
ifdef::offline_onprem[]
.. Copy the contents of the local Maven cache directory (`~/.m2/repository`) to the `repository` subdirectory that was created.
. Copy the contents of the `repository` subdirectory to a directory on the computer on which you deployed {PRODUCT}. This directory becomes the offline Maven mirror repository.
. Create and configure a `settings.xml` file for your {PRODUCT} deployment as described in
ifeval::["{context}"=="install-on-eap"]
<<maven-external-configure-proc_install-on-eap>>.
endif::[]
ifeval::["{context}"=="install-on-jws"]
<<maven-settings-configuration-ref_install-on-jws>>.
endif::[]
ifeval::["{context}"=="install-on-tomcat"]
<<maven-settings-configuration-ref_install-on-tomcat>>.
endif::[]
. Make the following changes in the `settings.xml` file:
** Under the `<profile>` tag, if a `<repositories>` or `<pluginRepositores>` tag is missing, add the missing tags.
** Under `<repositories>` add the following content:
+
[source,xml]
----
<repository>
  <id>offline-repository</id>
  <url>file:///path/to/repo</url>
  <releases>
    <enabled>true</enabled>
  </releases>
  <snapshots>
    <enabled>false</enabled>
  </snapshots>
</repository>
----
+
Replace `/path/to/repo` with the full path to the local Maven mirror repository directory.
** Under `<pluginRepositories>` add the following content:
+
[source,xml]
----
<repository>
  <id>offline-plugin-repository</id>
  <url>file:///path/to/repo</url>
  <releases>
    <enabled>true</enabled>
  </releases>
  <snapshots>
    <enabled>false</enabled>
  </snapshots>
</repository>
----
+
Replace `/path/to/repo` with the full path to the local Maven mirror repository directory.
ifeval::["{context}"=="install-on-eap"]
+
. Set the `kie.maven.offline.force` property for {CENTRAL} to `true`. For instructions about setting properties for {CENTRAL}, see {URL_INSTALLING_AND_CONFIGURING}#business-central-system-properties-ref_install-on-eap[_{INSTALLING_ON_EAP}_].
//Emily to revist this link.
endif::[]
endif::offline_onprem[]
