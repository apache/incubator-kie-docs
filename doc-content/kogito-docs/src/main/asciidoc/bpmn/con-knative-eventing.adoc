[id='con-knative-eventing_{context}']
= Knative Eventing in {PRODUCT} services

https://knative.dev/docs/eventing/[Knative Eventing] is a system that enables you to create event producers and consumers for your applications. Knative Eventing uses standard HTTP POST requests to send and receive events between event producers and consumers. These events conform to the https://github.com/cloudevents/spec[CloudEvents specification], which enables creating, parsing, sending, and receiving events in any programming language.

{PRODUCT} provides a `knative-eventing-addon` add-on that enables you to use Knative Eventing with {PRODUCT} services that consume or publish messages within a Business Process Model and Notation (BPMN) process model or Serverless Workflow. {PRODUCT} runtime events for messages, processes, tasks, and other application activities are published in https://cloudevents.io/[CloudEvents] format so that they can be consumed efficiently by other entities, such as the Knative Eventing system.

NOTE: Knative Eventing is currently supported for {PRODUCT} services on Quarkus only. The {PRODUCT} Operator supports Knative Eventing 0.17 or later.

For example, the following `handle-travelers.bpmn2` process uses messaging start and end events to communicate with travelers:

.Example process with messaging start and end events
image::kogito/bpmn/bpmn-messaging-example.png[Image of BPMN process receiving and publishing messages]

When the Knative Eventing add-on is enabled in the {PRODUCT} project that contains this example process, an event consumer is generated from the message start node and an event producer is generated from the message end node at build time.

The following diagram illustrates a scenario with Knative Eventing and a {PRODUCT} service that contains event consumers:

.Knative Eventing and a {PRODUCT} service with event consumers
image::kogito/bpmn/kogito-knative-impl-listening-event.png[{PRODUCT} service listening to events]

In this scenario, three Knative Eventing https://knative.dev/docs/eventing/triggers/[Triggers] are generated to filter the messages that are received by the {PRODUCT} service. These messages are sent to the default {PRODUCT} service port. A message-routing mechanism in the generated code redirects the message to an inner channel based on the name of the message start event in the BPMN process model. The names of message start and end events serve as unique CloudEvents https://github.com/cloudevents/spec/blob/v1.0/spec.md#type[`type` attribute] definitions in Knative Eventing.

In the example `handle-travlers.bpmn2` process, the message start node is named `travelers`, so a message with a `type` named `travelers` triggers the message start node, as shown in the following example curl request:

.Example request to trigger the `travelers` message start event
[source]
----
$ curl -X POST \
      -H "content-type: application/json"  \
      -H "ce-specversion: 1.0"  \
      -H "ce-source: /from/localhost"  \
      -H "ce-type: travelers"  \
      -H "ce-id: 12346"  \
      -d '{"firstName": "Jane", "lastName": "Doe", "email": "jane.doe@example.com", "nationality": "German"}' \
  http://localhost:8080
----

The following diagram illustrates a scenario with Knative Eventing and a {PRODUCT} service that contains event producers:

.Knative Eventing and a {PRODUCT} service with event producers
image::kogito/bpmn/kogito-knative-impl-producing-event.png[{PRODUCT} service producing events]

In this scenario, the {PRODUCT} service sends HTTP POST messages to the Knative Eventing https://knative.dev/docs/eventing/broker/[Broker] through the `SinkBinding` resource. The `SinkBinding` endpoint is generated by the Knative Eventing platform and is injected in the {PRODUCT} service container as an environment variable named `${K_SINK}`.

The following example message is generated by the {PRODUCT} service:

.Example message generated by the {PRODUCT} service
[source]
----
Context Attributes,
  specversion: 1.0
  type: process/travelers/processedtravellers
  source: /process/Travelers/2f692fd9-fff8-4b0a-bb64-96d1a4772490
  id: 29e43b17-3a70-4b46-aca0-7ab8e2133eee
  time: 2020-08-10T20:52:39.383346Z
Extensions,
  knativearrivaltime: 2020-08-10T20:52:39.391404032Z
  knativehistory: default-kne-trigger-kn-channel.kogito.svc.cluster.local
  kogitoprocessid: Travelers
  kogitoprocessinstanceid: 2f692fd9-fff8-4b0a-bb64-96d1a4772490
  kogitoprocessinstancestate: 1
Data,
  {"firstName":"Jan","lastName":"Kowalski","email":"jan.kowalski@example.com","nationality":"German","processed":true}
----

In this case, the CloudEvents `type` attribute uses the format `process/__PROCESS_ID__/__NODE_NAME__`. This format prevents the messages generated by the {PRODUCT} service from conflicting with other messages being generated within the cluster, and enables the `SinkBinding` objects to filter these messages by a unique `type`. The generated CloudEvents message also contains information about the process instance, such as the process ID, process instance ID, and process instance state.

The following diagram illustrates the overall architecture of a {PRODUCT} service deployed in a Knative Eventing environment on a Kubernetes or OpenShift cluster:

.{PRODUCT} service deployed in Knative Eventing environment on Kubernetes or OpenShift
image::kogito/bpmn/kogito-knative-deployment-architecture.png[{PRODUCT} service deployed on Knative Eventing environment]
