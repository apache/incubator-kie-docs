[id='con-kogito-operator-with-knative-eventing_{context}']
= {PRODUCT} Operator interaction with Knative Eventing

{PRODUCT} provides a `knative-eventing-addon` add-on that enables Knative Eventing integration for {PRODUCT} services. The {PRODUCT} Operator uses the  https://knative.dev/docs/eventing/[Knative Eventing] platform to implement an event-driven architecture based on https://github.com/cloudevents/spec/blob/v1.0/spec.md[CloudEvents] with {PRODUCT} services. Due to this dependency, the Knative Eventing platform must be installed in the same cluster as your {PRODUCT} project.

NOTE: Knative Eventing is currently supported for {PRODUCT} services on Quarkus only. The {PRODUCT} Operator supports Knative Eventing 0.17 or later.

When you deploy a {PRODUCT} service that uses the `knative-eventing-addon` add-on, you must also deploy a Knative Eventing https://knative.dev/docs/eventing/broker/[Broker] in the same namespace. The {PRODUCT} service uses this Broker to publish or listen to CloudEvents messages. You can use any Broker channel for the {PRODUCT} service, such as InMemoryChannel, KafkaChannel, or NatssChannel.

By default, the InMemoryChannel channel is used when no channel is specified, as shown in the following `Broker` custom resource example:

.Example `Broker` custom resource for Knative Eventing with default InMemoryChannel
[source,yaml]
----
apiVersion: eventing.knative.dev/v1
kind: Broker
metadata:
  name: default
----

NOTE: InMemoryChannel channels are for development use only. Do not use this channel in a production deployment.

For more information about available Broker channels and how to install them, see https://knative.dev/docs/eventing/channels/channels-crds/[Available Channels] in the Knative documentation.

To bind this Knative Eventing Broker instance to the {PRODUCT} service being deployed, you must create a `KogitoInfra` instance, as shown in the following example:

.Example `KogitoInfra` custom resource for a {PRODUCT} service with `Broker` binding
[source,yaml]
----
apiVersion: app.kiegroup.org/v1alpha1
kind: KogitoInfra
metadata:
  name: kogito-knative-infra
spec:
  # Bind Knative Broker to the service
  resource:
    apiVersion: eventing.knative.dev/v1
    kind: Broker
    name: default
----

The `KogitoRuntime` resource used to deploy the {PRODUCT} service using the {PRODUCT} Operator must have this `KogitoInfra` instance linked to it, as shown in the following example:

.Example `KogitoRuntime` custom resource for a {PRODUCT} service with `KogitoInfra` bound to it
[source,yaml,subs="+quotes"]
----
apiVersion: app.kiegroup.org/v1alpha1
kind: KogitoRuntime
metadata:
  name: process-knative-quickstart-quarkus
spec:
  replicas: 1
  image: quay.io/__NAME_SPACE__/process-knative-quickstart-quarkus:latest
  # Reference to the KogitoInfra resource with the Knative Broker binding
  infra:
  - kogito-knative-infra
----

After you apply these resources to a Kubernetes namespace, if any BPMN or Serverless Workflow files in the {PRODUCT} project contain events to be consumed or produced, the {PRODUCT} Operator automatically creates the required Knative Eventing https://knative.dev/docs/eventing/triggers/[Triggers] for the events to be consumed and the https://knative.dev/docs/eventing/samples/sinkbinding/[`SinkBinding`] resource for the events to be produced.

To consume events published by your application or to produce events for the Broker, you must create the required `Trigger` and `SinkBinding` resources as shown in the following examples:

.Example `Trigger` custom resource for consuming events
[source,yaml]
----
apiVersion: eventing.knative.dev/v1
kind: Trigger
metadata:
  name: travelers-trigger
spec:
  # The default Broker is enabled in the cluster because the namespace is labeled with `knative-eventing-injection=enabled`.
  broker: default
  filter:
    attributes:
      # Name of the message node in the process.
      type: travelers
  # The subscriber is the deployed service. Any event that matches the filter in the Broker is sent here.
  subscriber:
    ref:
      apiVersion: v1
      kind: Service
      name: process-knative-quickstart-quarkus
----

.Example `SinkBinding` custom resource for producing events
[source,yaml]
----
apiVersion: sources.knative.dev/v1alpha1
kind: SinkBinding
metadata:
  name: process-knative-quickstart-quarkus-sink
spec:
  subject:
    apiVersion: apps/v1
    kind: Deployment
    selector:
      matchLabels:
        app: process-knative-quickstart-quarkus
  # Any cloud event produced by the application is delivered to the Broker.
  sink:
    ref:
      apiVersion: eventing.knative.dev/v1
      kind: Broker
      name: default
----

.Additional resources
ifdef::KOGITO[]
* {URL_PROCESS_SERVICES}#proc-knative-eventing-process-services_kogito-developing-process-services[Enabling Knative Eventing for {PRODUCT} services]
endif::[]
ifdef::KOGITO-COMM[]
* xref:proc-knative-eventing-process-services_kogito-developing-process-services[]
endif::[]
* https://knative.dev/docs/eventing/[Knative Eventing]
