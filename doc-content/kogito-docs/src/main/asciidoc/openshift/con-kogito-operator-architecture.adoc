[id='con-kogito-operator-architecture_{context}']
= {PRODUCT} Operator architecture

The {PRODUCT} Operator is written in https://golang.org/[Go] and is built with the https://sdk.operatorframework.io/[Operator SDK]. The {PRODUCT} Operator uses the https://kubernetes.io/docs/concepts/overview/kubernetes-api/[Kubernetes API] for most of the deployment tasks that the operator facilitates and for other internal operations.

The {PRODUCT} Operator uses the following custom resources to deploy {PRODUCT} domain-specific services (the services that you develop), {PRODUCT} supporting services, and middleware infrastructure components:

* `KogitoBuild`: Defines the build configurations for {PRODUCT} domain-specific services deployed on OpenShift
ifdef::KOGITO-COMM[]
* `KogitoRuntime`: Defines the deployment configurations for {PRODUCT} domain-specific services deployed on Kubernetes or OpenShift from a container image in an image registry
endif::[]
* `KogitoDataIndex`, `KogitoJobsService`, and `KogitoMgmtConsole`: Define the deployment configurations for the {PRODUCT} Data Index Service, Jobs Service, and Management Console
* `KogitoInfra`: Defines the relevant middleware infrastructure component or third-party operator for the {PRODUCT} service, such as Infinispan for persistence or Apache Kafka for messaging

.Additional resources
* https://github.com/kiegroup/kogito-cloud-operator[{PRODUCT} Operator source]
* https://github.com/kiegroup/kogito-cloud-operator/tree/master/examples[{PRODUCT} Operator deployment examples]
* https://sdk.operatorframework.io/docs/[Operator SDK documentation]
* https://github.com/operator-framework/operator-sdk/tree/master/example[Operator SDK examples]

== {PRODUCT} Operator dependencies on third-party operators

The {PRODUCT} Operator uses the following third-party operators to deploy {PRODUCT} service infrastructure components:

* *https://github.com/infinispan/infinispan-operator[Infinispan Operator]*: Used to deploy Infinispan Server instances for process data persistence in {PRODUCT} services
* *https://github.com/strimzi/strimzi-kafka-operator[Strimzi Operator]*: Used to deploy Apache Kafka clusters with Zookeeper for messaging in {PRODUCT} services
* *https://github.com/keycloak/keycloak-operator[Keycloak Operator]*: Used to deploy Keycloak server instances for security and single sign-on capabilities in {PRODUCT} services

When you enable an infrastructure mechanism through a `KogitoInfra` deployment, the {PRODUCT} Operator uses the relevant third-party operator to create the infrastructure.

For example, the following `kogito-infinispan-infra` custom resource uses the `spec.resource.apiVersion` and `spec.resource.kind` configurations to enable Infinispan persistence for the {PRODUCT} service:

.Example {PRODUCT} infrastructure resource for Infinispan persistence
[source,yaml]
----
apiVersion: app.kiegroup.org/v1alpha1
kind: KogitoInfra
metadata:
  name: kogito-infinispan-infra
spec:
  resource:
    apiVersion: infinispan.org/v1
    kind: Infinispan
----

In this example, if an Infinispan Server instance named `kogito-infinispan` does not exist, then the {PRODUCT} Operator uses the Infinispan Operator to deploy the Infinispan Server instance for persistence.

Similar to the previous example, the following `kogito-kafka-infra` custom resource uses the `spec.resource.apiVersion` and `spec.resource.kind` configurations to enable Kafka messaging for the {PRODUCT} service:

.Example {PRODUCT} infrastructure resource for Kafka messaging
[source,yaml]
----
apiVersion: app.kiegroup.org/v1alpha1
kind: KogitoInfra
metadata:
  name: kogito-kafka-infra
spec:
  resource:
    apiVersion: kafka.strimzi.io/v1beta1
    kind: Kafka
----

In this example, if a Kafka cluster named `kogito-kafka` does not exist, then the {PRODUCT} Operator uses the Strimzi Operator to deploy the Kafka cluster for event messaging.

If you have a custom infrastructure resource, you can specify it in the `spec.resource.name` and `spec.resource.namespace` configurations:

.Example {PRODUCT} infrastructure resource for custom messaging
[source,yaml]
----
apiVersion: app.kiegroup.org/v1alpha1
kind: KogitoInfra
metadata:
  name: my-kafka-infra
spec:
  resource:
    apiVersion: kafka.strimzi.io/v1beta1
    kind: Kafka
    name: my-kafka-instance
    namespace: my-namespace
----

In this example, the `KogitoInfra` custom resource does not deploy a Kafka cluster, but connects to the Kafka cluster named `my-kafka-instance` from the namespace `my-namespace` for event messaging.

If the required third-party operators are not available to the {PRODUCT} Operator during {PRODUCT} service runtime, then the {PRODUCT} Operator cannot generate the infrastructure components and the user must install these operators in the OpenShift or Kubernetes cluster.

The {PRODUCT} Data Index Service similarly depends on Infinispan and Kafka infrastructure components. Without Infinispan persistence and Kafka messaging, the Data Index Service cannot function properly. However, you can specify whether the Data Index Service uses the general infrastructure components that the {PRODUCT} Operator generates or a custom alternative for that component.

For example, by default, the `KogitoDataIndex` resource specifies the `infra` configuration for both Infinispan and Kafka in order to use the corresponding infrastructure components:

.Default `KogitoDataIndex` resource configuration with persistence and messaging
[source,yaml]
----
apiVersion: app.kiegroup.org/v1alpha1
kind: KogitoDataIndex
metadata:
  name: data-index
spec:
  replicas: 1
  infra:
     - kogito-infinispan-infra
     - kogito-kafka-infra
----

You typically create `kogito-infinispan-infra` and `kogito-kafka-infra` custom resources before configuring the `KogitoDataIndex` custom resource.

== {PRODUCT} Operator core package structure

The {PRODUCT} Operator uses the following core packages. Your understanding of the {PRODUCT} Operator package structure can help you use the operator more effectively or contribute to the development of the operator.

.{PRODUCT} Operator core package structure
image::kogito/openshift/kogito-operator-packages.png[Image of Kogito Operator package layout]

The following list describes the function and interaction of these core packages:

* `cmd`: Contains the operator entry point and CLI implementation
** `manager`: Serves as the entry point for the {PRODUCT} Operator image
** `kogito`: Provides the implementation for the {PRODUCT} CLI
* `test`: Contains the implementation for Behavior Driven Development (BDD) tests based on https://github.com/cucumber/godog[Godog] (by Cucumber for Go)
** `config`: Provides the configuration for BDD tests
** `features`: Defines the features for BDD tests
** `framework`: Provides the support API framework to interact with other operator components
** `steps`: Defines BDD test steps
* `pkg`: Contains the implementation for the {PRODUCT} Operator
** `apis`: Defines the custom resource definition types for the resources that are managed by the {PRODUCT} Operator
** `client`: Serves as a wrapper for the Kubernetes and OpenShift clients
** `controller`: Defines the business logic for how the {PRODUCT} Operator responds to changes to the resources that are managed by the operator
** `framework`: Provides the common code related to any Kubernetes operator for all controllers
** `infrastructure`: Provides the common code related to the {PRODUCT} Operator infrastructure for all controllers, such as external endpoints among the services that are managed by the operator
** `logger`: Provides the implementation for the common logger for all other packages, based on https://github.com/uber-go/zap[Zap] (by Uber Go)
** `util`: Provides the common https://golang.org/[Go] utilities used across the project

To explore {PRODUCT} Operator packages or contribute to the operator development, see the https://github.com/kiegroup/kogito-cloud-operator[{PRODUCT} Operator source] repository in GitHub.
