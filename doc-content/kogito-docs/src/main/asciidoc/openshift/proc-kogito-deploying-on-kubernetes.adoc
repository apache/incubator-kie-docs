[id='proc-kogito-deploying-on-kubernetes_{context}']
= Deploying {PRODUCT} services on Kubernetes

Starting with {PRODUCT} 0.11, the {PRODUCT} Operator supports {PRODUCT} service deployment on Kubernetes. After you create your {PRODUCT} services as part of a business application, you can build a container image for your {PRODUCT} project, push the image to an image registry, and then use the {PRODUCT} Operator to deploy your services on Kubernetes from the registered container image.

The {PRODUCT} Operator uses a `KogitoRuntime` custom resource that enables Kubernetes or OpenShift deployment from a registered container image. This resource does not require you to build the images in the cluster. Instead, you can pass the {PRODUCT} service image that you want to deploy and the {PRODUCT} Operator handles the building and deployment for you.

For example {PRODUCT} service configurations for a Kubernetes deployment, see the https://github.com/kiegroup/kogito-cloud-operator/tree/master/examples/kubernetes/travel-agency[`travel-agency`] example application for Kubernetes.

.Prerequisites
* The Kubernetes command-line tool `kubectl` is installed. For installation instructions, see the https://kubernetes.io/docs/tasks/tools/install-kubectl/[Kubernetes documentation].
* Podman container manager is installed. For installation instructions, see the https://podman.io/getting-started/installation[Podman documentation].
* The application with your {PRODUCT} services is in a location that is reachable from your Kubernetes environment.
* You have Kubernetes permissions to create resources in a specified namespace.

.Procedure
. Go to the https://github.com/kiegroup/kogito-cloud-operator/releases[`{PRODUCT_INIT}-cloud-operator`] releases page in GitHub, download the latest version of the {PRODUCT} Operator `Source code` file, and extract the downloaded `kogito-cloud-operator-__VERSION__` file to a local directory.
+
The {PRODUCT} Operator source code contains resources for installing the operator manually for Kubernetes deployments.
. In a command terminal, navigate to the root of the extracted `kogito-cloud-operator-__VERSION__` folder and enter the following commands to create the Kubernetes namespace (if not created already) and to install the {PRODUCT} Operator in that namespace:
+
--
.Installing the {PRODUCT} Operator in a Kubernetes namespace
[source,subs="attributes+,+quotes"]
----
$ cd ~/kogito-cloud-operator-__VERSION__

// Creates the Kubernetes namespace (if not created already)
$ export NAMESPACE=kogito
$ kubectl create ns $NAMESPACE

// Installs the {PRODUCT} Operator in the namespace
$ ./hack/install.sh
----

NOTE: You must be logged in to the relevant Kubernetes cluster using the `kubectl` command. For more information about accessing Kubernetes clusters, see the https://kubernetes.io/docs/tasks/access-application-cluster/access-cluster/[Kubernetes documentation].

--
. If your {PRODUCT} project requires Infinispan persistence and Apache Kafka messaging, install the required Infinispan and Kafka infrastructure components, including the https://github.com/infinispan/infinispan-operator[Infinispan Operator] and the https://strimzi.io/docs/latest/[Strimzi Operator] (for Kafka cluster deployment with Zookeeper).
+
--
In a Kubernetes deployment, the {PRODUCT} Operator cannot install Infinispan persistence and Kafka messaging infrastructures automatically, so you must install these components manually.

For information about Infinispan installation and configuration, see the https://infinispan.org/documentation/[Infinispan documentation].

For information about Kafka installation and configuration, see the https://kafka.apache.org/documentation/[Apache Kafka documentation].

For an example script to install these infrastructure components for Kubernetes, see the https://github.com/kiegroup/kogito-cloud-operator/blob/master/examples/kubernetes/travel-agency/deploy.sh[`travel-agency`] example application for Kubernetes.
--
. Add the following `quarkus-jvm.Dockerfile` file or `springboot.Dockerfile` file, depending on your framework, to the root of your {PRODUCT} project to prepare your project for being built and registered as a container image:
+
--
.On Quarkus: `quarkus-jvm.Dockerfile`
[source]
----
FROM quay.io/kiegroup/kogito-quarkus-jvm-ubi8:latest

COPY target/*-runner.jar $KOGITO_HOME/bin
COPY target/lib $KOGITO_HOME/bin/lib
COPY target/classes/persistence/ $KOGITO_HOME/data/protobufs
----

.On Spring Boot: `springboot.Dockerfile`
[source]
----
FROM quay.io/kiegroup/kogito-springboot-ubi8:latest

COPY target/*.jar $KOGITO_HOME/bin
COPY target/classes/persistence/ $KOGITO_HOME/data/protobufs
----
--
. Build your {PRODUCT} project with your preferred method, such as `mvn clean package`.
. Enter the following commands to build the container image, test the image locally, and push the image to the registry using Podman:
+
.Build, test, and push the container image using Podman
[source,subs="attributes+,+quotes"]
----
// Builds the container image
`podman build --tag quay.io/__NAMESPACE__/__PROJECT_NAME__:latest -f quarkus-jvm.Dockerfile`

// Runs the container image locally for testing
`podman run --rm -it -p 8080:8080 quay.io/__NAME_SPACE__/__PROJECT_NAME__:latest`

// Pushes the container image to the Quay registry
`podman push quay.io/__NAME_SPACE__/__PROJECT_NAME__:latest`
----
. After you build and push the container image for your {PRODUCT} project, create a {PRODUCT} service definition YAML file as a `KogitoRuntime` custom resource for your {PRODUCT} service, as shown in the following example:
+
--
.Example `kogito-travels.yaml` resource for the {PRODUCT} service
[source,yaml,subs="attributes+,+quotes"]
----
apiVersion: app.kiegroup.org/v1alpha1
kind: KogitoRuntime
metadata:
  name: kogito-travels
spec:
  envs:
    - name: KOGITO_DATAINDEX_HTTP_URL
      value: http://data-index.kogito
    - name: KOGITO_DATAINDEX_WS_URL
      value: ws://data-index.kogito
  replicas: 1
  image:
    domain: quay.io
    namespace: kiegroup
    name: kogito-travels
  kafka:
    useKogitoInfra: true
  infinispan:
    useKogitoInfra: true
----

This example is based on the https://github.com/kiegroup/kogito-cloud-operator/tree/master/examples/kubernetes/travel-agency[`travel-agency`] example application for Kubernetes and includes additional configurations for Infinispan persistence, Kafka messaging, and the {PRODUCT} Data Index Service.
--
. Enter the following command to deploy your {PRODUCT} service custom resource to your Kubernetes cluster:
+
.Deploying the {PRODUCT} service resource to the Kubernetes cluster
[source]
----
kubectl apply -f kogito-travels.yaml
----
