[id='con-kogito-operator-with-kafka_{context}']
= {PRODUCT} Operator interaction with Apache Kafka

You can use the following {PRODUCT} command-line interface (CLI) operation to install the Apache Kafka infrastructure for messaging in {PRODUCT} services:

.Enable Kafka messaging
[source,subs="attributes+,+quotes"]
----
$ {PRODUCT_INIT} install kafka -p __PROJECT_NAME__
----

When you install the Kafka infrastructure for your {PRODUCT} project, the {PRODUCT} Operator creates a `KogitoInfra` custom resource to handle the Kafka cluster deployment for you. This resource is added to your {PRODUCT} project and in the {PRODUCT} Operator page of the *Installed Operators* listed in the OpenShift web console, if applicable.

The {PRODUCT} Operator relies on the https://strimzi.io/docs/latest/[Strimzi Operator] to deploy a Kafka cluster with Zookeeper to support sending and receiving messages within a process. Due to this dependency, the {PRODUCT} Operator installs the Strimzi Operator as part of the Kafka infrastructure. You can edit the Kafka instance deployed by the Strimzi Operator to meet your requirements.

== Apache Kafka messaging in {PRODUCT} services

After you install the Apache Kafka infrastructure, to enable Kafka messaging for a {PRODUCT} service using the {PRODUCT} Operator, use the `--enable-events` flag during deployment in the {PRODUCT} CLI or edit the `spec.enableEvents` configuration in the `KogitoApp` custom resource:

* `true`: Kafka is installed and deploys a Kafka cluster in the namespace if no Kafka cluster owned by the {PRODUCT} Operator exists.
* `false`: Kafka is not installed. Use this option only if you do not need messaging or if you intend to deploy your own messaging mechanism and you know how to configure your service to access it.

.Example {PRODUCT} service deployment from local source with Kafka messaging enabled
[source,subs="attributes+,+quotes"]
----
$ {PRODUCT_INIT} deploy-service travels --enable-events
----

.Example {PRODUCT} service custom resource with Kafka messaging enabled
[source,yaml]
----
apiVersion: app.kiegroup.org/v1alpha1
kind: KogitoApp
metadata:
  name: travels
spec:
  enableEvents: true
  build:
    envs:
    - name: MAVEN_ARGS_APPEND
      value: -Pevents
    gitSource:
      uri: https://github.com/kiegroup/kogito-examples/kogito-travel-agency
      contextDir: travels
----

When you enable Kafka messaging, a variable named `KAFKA_BOOTSTRAP_SERVERS` is injected into the service container. On Quarkus, this is the default behavior when you use https://quarkus.io/guides/kafka-streams#topic-configuration[Kafka Client] 1.x or later. On Spring Boot, you might need to use a property substitution in the `application.properties` file, such as the following example:

.Example application property substitution for Kafka on Spring Boot
[source]
----
spring.kafka.bootstrap.servers=${KAFKA_BOOTSTRAP_SERVERS}
----

If the service container has any environment variables with the suffix `_BOOTSTRAP_SERVERS`, the variables are also injected by the value of the `KAFKA_BOOTSTRAP_SERVERS` variable.

For example, when you deploy the following {PRODUCT} service, the variables `MP_MESSAGING_INCOMING_TRAVELLERS_BOOTSTRAP_SERVERS` and `MP_MESSAGING_OUTGOING_PROCESSEDTRAVELLERS_BOOTSTRAP_SERVERS` are injected with the deployed Kafka service URL:

.Example {PRODUCT} service deployment with injected Kafka variable values
[source]
----
$ kogito deploy-service travels https://github.com/kiegroup/kogito-examples/kogito-travel-agency --context-dir travels --enable-events \
--build-env MAVEN_ARGS_APPEND="-Pevents" \
-e MP_MESSAGING_INCOMING_TRAVELLERS_BOOTSTRAP_SERVERS
-e MP_MESSAGING_OUTGOING_PROCESSEDTRAVELLERS_BOOTSTRAP_SERVERS
----

[NOTE]
.Kafka messaging with the {PRODUCT} Data Index Service
====
For the {PRODUCT} Data Index Service, if you do not provide a service URL to connect to Kafka or the name of a Kafka instance that was deployed by Strimzi, a new Kafka instance is deployed automatically in the `KogitoInfra` custom resource. You do not need to do anything for both services to work together.
====

.Additional resources
ifdef::KOGITO[]
* {URL_CONFIGURING_KOGITO}#proc-messaging-enabling_kogito-configuring[Enabling messaging for {PRODUCT} services]
* {URL_CONFIGURING_KOGITO}#con-data-index-service_kogito-configuring[{PRODUCT} Data Index Service]
endif::[]
ifdef::KOGITO-COMM[]
* xref:proc-messaging-enabling_kogito-configuring[]
* xref:con-data-index-service_kogito-configuring[]
endif::[]
