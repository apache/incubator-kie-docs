[id='con-kogito-operator-with-infinispan_{context}']
= {PRODUCT} Operator interaction with Infinispan

You can install the Infinispan infrastructure for process data persistence in {PRODUCT} services by using the following {PRODUCT} CLI operation or by providing a `KogitoInfra` custom resource definition:

.Enable Infinispan persistence using the {PRODUCT} CLI
[source,subs="attributes+,+quotes"]
----
$ {PRODUCT_INIT} install infra __INFINISPAN_INFRA_NAME__ --kind Infinispan --apiVersion infinispan.org/v1 -p __PROJECT_NAME__
----

.Enable Infinispan persistence using a custom resource definition
[source,yaml]
----
apiVersion: app.kiegroup.org/v1alpha1
kind: KogitoInfra
metadata:
  name: INFINISPAN_INFRA_NAME
spec:
  resource:
    apiVersion: infinispan.org/v1
    kind: Infinispan
----

When you install the Infinispan infrastructure for your {PRODUCT} project using the {PRODUCT} CLI, the {PRODUCT} Operator creates a `KogitoInfra` custom resource to handle Infinispan deployment for you. This resource is added to your {PRODUCT} project and in the {PRODUCT} Operator page of the *Installed Operators* listed in the OpenShift web console, if applicable.

The `KogitoInfra` resource uses the https://github.com/infinispan/infinispan-operator[Infinispan Operator] to deploy new Infinispan Server instances when needed. Due to this dependency, the Infinispan Operator must be installed in the same namespace where you deployed the custom {PRODUCT} service. For information about Infinispan Operator installation, see the https://infinispan.org/infinispan-operator/master/operator.html[Infinispan Operator Guide].

The {PRODUCT} Operator does not manage Infinispan instances, but you can edit and manage Infinispan instances as needed. For example, if you want to scale the Infinispan cluster, you can edit the `replicas` field in the https://github.com/infinispan/infinispan-operator/blob/master/pkg/apis/infinispan/v1/infinispan_types.go[`infinispan_types.go`] custom resource to meet your requirements.

By default, the `KogitoInfra` resource creates a secret that holds the user name and password for Infinispan authentication. To view the credentials, enter the following command:

.View {PRODUCT} Infinispan credentials
[source]
----
$ oc get secret/kogito-infinispan-credential -o yaml

apiVersion: v1
data:
  password: VzNCcW9DeXdpMVdXdlZJZQ==
  username: ZGV2ZWxvcGVy
kind: Secret
...
----

The key values are masked by a Base64 algorithm. To view the password from the previous example output in your terminal, enter the following command:

.Reveal {PRODUCT} Infinispan password
[source]
----
$ echo VzNCcW9DeXdpMVdXdlZJZQ== | base64 -d

W3BqoCywi1WWvVIe
----

== Infinispan persistence in {PRODUCT} services

After you install the `KogitoInfra` custom resource to connect with the Infinispan infrastructure, to enable Infinispan persistence for a {PRODUCT} service using the {PRODUCT} Operator, use the `--infra __INFINISPAN_INFRA_NAME__` flag during deployment in the {PRODUCT} CLI or edit the `spec.infra` configuration in the `KogitoRuntime` custom resource:

.Example {PRODUCT} service deployment with Infinispan persistence enabled using the {PRODUCT} CLI
[source,subs="attributes+,+quotes"]
----
$ {PRODUCT_INIT} deploy-service travels --infra __INFINISPAN_INFRA_NAME__
----

.Example {PRODUCT} service custom resource with Infinispan persistence enabled
[source,yaml]
----
apiVersion: app.kiegroup.org/v1alpha1
kind: KogitoRuntime
metadata:
  name: travels
spec:
  infra:
    - INFINISPAN_INFRA_NAME
----

If you set up a custom Infinispan cluster, you can refer to it in the `KogitoRuntime` custom resource by configuring the following environment variables and application properties:

.Required environment variables for a custom Infinispan cluster
[source]
----
ENABLE_PERSISTENCE=true

# On Quarkus
QUARKUS_INFINISPAN_CLIENT_AUTH_USERNAME
QUARKUS_INFINISPAN_CLIENT_AUTH_PASSWORD

# On Spring Boot
INFINISPAN_REMOTE_AUTH_USERNAME
INFINISPAN_REMOTE_AUTH_PASSWORD
----

.Required application properties for a custom Infinispan cluster
[source]
----
# On Quarkus
quarkus.infinispan-client.server-list=
quarkus.infinispan-client.use-auth=
quarkus.infinispan-client.sasl-mechanism=
quarkus.infinispan-client.auth-realm=

# On Spring Boot
infinispan.remote.server-list=
infinispan.remote.use-auth=
infinispan.remote.sasl-mechanism=
infinispan.remote.auth-realm=
----

.Additional resources
ifdef::KOGITO[]
* {URL_CONFIGURING_KOGITO}#con-persistence_kogito-configuring[Persistence in {PRODUCT}]
* {URL_CONFIGURING_KOGITO}#con-data-index-service_kogito-configuring[{PRODUCT} Data Index Service]
endif::[]
ifdef::KOGITO-COMM[]
* xref:con-persistence_kogito-configuring[]
* xref:con-data-index-service_kogito-configuring[]
endif::[]
* https://github.com/infinispan/infinispan-operator/blob/master/README.md[Infinispan Operator]
