[id='clustering-create-dev-proc']
= Configuring {EAP} 7.1 for a {PRODUCT} development environment

Complete the steps in this section to install {EAP} 7.1 and configure it for a clustered environment with Elasticsearch and the Artemis Java messaging server (JMS) broker resource adapter integrated with {EAP}. The Artemis JMS broker resource adapter enables your applications to communicate with any messaging provider. It specifies how components such as message-driven beans, Enterprise JavaBeans, and servlets can send or receive messages.

[NOTE] 
====
These steps describe a basic cluster configuration. For more complex configurations, see the https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.0/html/configuration_guide[_Red Hat JBoss EAP 7.1 Configuration Guide_].
====

Elasticsearch is installed as described in <<clustering-elasticsearch-proc_{context}>>.

.Procedure
. Navigate to the https://access.redhat.com/jbossnetwork/restricted/listSoftware.html[Software Downloads] page in the Red Hat Customer Portal (login required), and select the product and version from the drop-down options:
* *Product: Enterprise Application Platform*
* *Version: 7.1*
. Click *Download* next to *Red Hat JBoss Enterprise Application Platform 7.1.0*. (`JBEAP-7.1.0/jboss-eap-7.1.0.zip`).
. Extract the `jboss-eap-7.1.0.zip` file. In the following steps, `_EAP_HOME_` is the `jboss-eap-7.1/jboss-eap-7.1` directory.
. In the `_EAP_HOME_/domain/configuration/domain.xml` file, edit the `server-groups` element to specify the server groups to be used in the cluster and the names of their JVMs. 
+
A server group is a set of server instances that are managed and configured together. You can manage configurations, deployments, socket bindings, modules, extensions, and system properties for each server group. 
. Make the following changes to each server group in the `server-groups` element:
.. To enable high availability, change the `profile` to `"full-ha"` and the `socket-binding-group` to `"full-ha-sockets"`.
.. To prevent {CENTRAL} from running out of memory, increase the JVM maximum heap size to `1500m`.
+
[source]
----
<server-group name="some-server-group" profile="full-ha">
    <jvm name="some-jvm">
        <heap size="1000m" max-size="1500m"/>
    </jvm>
    <socket-binding-group ref="full-ha-sockets"/>
</server-group>
----
. In the `_EAP_HOME_/domain/configuration/domain.xml` file, edit or add the following properties to the `<system-properties>` element and replace the following placeholders:
* `<NIOGIT_DIR>` is the location of Git repositories stored under `.niogit`, on an NFS mounted partition accessible to a {EAP} user.
* `<ELASTICSEARCH_NODE_IP>` is the IP addresses where Elasticseach is installed.
* `<JMS_USER>` is a {EAP} application user. It is the user that {CENTRAL} uses to connect to the  embedded JMS broker.
* `<JMS_USER_PASSWORD>` is the password for `<JMS_USER>`.
+
[source,xml]
----
<system-properties>
  <property name="org.uberfire.nio.git.dir" value="
      <NIOGIT_DIR>"/> 
  <property name="appformer-jms-connection-mode" value="JNDI"/>
  <property name="appformer-jms-username" value="<JMS_USER>  "/>
  <property name="appformer-jms-password" value="<JMS_USER_PASSWORD>"/>
  <property name="org.appformer.ext.metadata.index" value="elastic"/>
  <property name="org.appformer.ext.metadata.elastic.port" value="9300"/>
  <property name="org.appformer.ext.metadata.elastic.host" 
      value="<ELASTICSEARCH_NODE_IP>"/>
  <property name="org.appformer.ext.metadata.elastic.cluster" 
      value="kie-cluster"/>
  <property name="org.appformer.ext.metadata.elastic.retries" value="10"/>
</system-properties>
----
. To configure the embedded Artemis JMS broker, edit the `domain.xml` file as follows:

.. To create an `outbound-socket-binding` pointing to the remote messaging server, add the following lines to the `<socket-binding-group name="full-sockets"` tag, where `localhost` is the host name or IP address of the remote {EAP} instance:
+
[source]
----
 <socket-binding-group name="full-sockets" default-interface="public">
.
.
.
    <outbound-socket-binding name="remote-server">
      <remote-destination host="localhost" port="8080"/>
    </outbound-socket-binding>
----
.. To create a `remote-connector` referencing the `outbound-socket-binding`, locate the `<subsystem xmlns="urn:jboss:domain:messaging-activemq:2.0">` profile and add the following lines to the `<server name="default">` section:
+
[source]
----
<http-connector name="remote-http-connector" socket-binding="remote-server" endpoint="http-acceptor"/>
----
.. To create a `connection-factory` referencing the new `remote-connector`, add the following line to the `"<server name="default">` section:
+
[source]
----
<connection-factory name="remote-artemis" entries="java:/jms/remoteCF" connectors="remote-http-connector"/>
----
.. Add the following property: COMMENT, please check all of the connection-factory references.
+
[source]
----
<property name="appformer-jms-connection-factory" value="java:/ConnectionFactory"/> 
----
.. Change `<cluster password="${jboss.messaging.cluster.password:CHANGE ME!!}"/>` where `<CLUSTER_USER>` is the (COMMENT WHAT?) and `<CLUSTER_PWD>` is the password for that user:
+
`<cluster user="<CLUSTER_USER>" password="<CLUSTER_PWD>"/>`
. In the `security-setting` element below this line, add the roles of the `<CLUSTER_USER>` and the `<JWS_USER>` to a new `role-name` element, for example:
+
[source]
----
<security-setting name="#">
    <role name="guest" send="true" consume="true" create-non-durable-queue="true" delete-non-durable-queue="true"/>
    <role name="admin" send="true" consume="true" create-non-durable-queue="true" delete-non-durable-queue="true"/>
</security-setting>
----

. In the `_EAP_HOME_/domain/configuration/host.xml` file `<servers>` element, in the `main-server-group`, add the servers that will be part of the cluster.
. In the `host.xml` file, add the the system properties listed in
ifdef::PAM[]
<<_cluster_properties_pam>>
endif::PAM[]
ifdef::DM[]
<<_cluster_properties_BRMS>>
endif::DM[]
to each server in the `main-server-group`.
+
ifdef::PAM[]
[id='_cluster_properties_pam']
.Cluster node properties
[cols="1,1,2", frame="all", options="header"]
|===
|Property Name
|Value
|Description

|`jboss.node.name`
|_node name_
|Node name unique within the cluster.

|`org.uberfire.metadata.index.dir`
|`/home/jbpm/node[N]/index`
|Location where the index for search is to be created (maintained by Apache Lucene).

|`org.uberfire.nio.git.daemon.host`
|_node name_
|The name of the daemon host machine in a physical cluster.

|`org.uberfire.nio.git.daemon.port`
|_port number_
|Port used by the VFS repo to accept client connections. The port must be unique for each cluster member.

|`org.uberfire.nio.git.dir`
|`/home/jbpm/node[N]/repo`
|Git (VFS) repository location on node[N]. COMMENT: You say to remove this because it is set in system properties in domain.xml, but it looks like it is unique for each node?

|`org.uberfire.nio.git.ssh.host`
|_SSH host node name_
|The name of the SSH host machine in a physical cluster.

|`org.uberfire.nio.git.ssh.port`
|_port number_
|The unique port number for ssh access to the GIT repo for a cluster running on physical machines.

|`org.uberfire.nio.git.ssh.hostport` and `org.uberfire.nio.git.daemon.hostport`
|_SSH host port_ and _daemon host port_
|In a virtualized environment, the outside port to be used.

|`org.appformer.ext.metadata.index`
|COMMENT: need description
|

|`org.appformer.ext.metadata.elastic.cluster`
|_Elasticsearch cluster name_
|The name of the Elasticsearch cluster

|`org.appformer.ext.metadata.elastic.port`
|_Elasticsearch port number_
|The Elasticsearch port

|`org.appformer.ext.metadata.elastic.host`
|_Elasticsearch node IP address_
|The IP address of the Elasticsearch node

|`org.appformer.ext.metadata.elastic.retries`
|10
|The number of times Elasticsearch retries... COMMENT retries what?
|===
endif::PAM[]
ifdef::DM[]
+
[id='_cluster_properties_BRMS']
.Cluster Node Properties
[cols="1,1,2", frame="all", options="header"]
|===
|Property Name
|Value
|Description

|org.uberfire.nio.git.dir
|/home/jbrm/node[N]/repo
|Git (VFS) repository location on node[N].

|jboss.node.name
|nodeOne
|Node name unique within the cluster.

|org.uberfire.nio.git.daemon.port
|9418
|Port used by the VFS repo to accept client connections. The port must be unique for each cluster member.

|org.uberfire.metadata.index.dir
|/home/jbrm/node[N]/index
|Location where the index for search is to be created (maintained by Apache Lucene).

|org.uberfire.nio.git.ssh.port
|8003
|The unique port number for ssh access to the Git repo for a cluster running on physical machines.

|org.uberfire.nio.git.daemon.host
|nodeOne
|The name of the daemon host machine in a physical cluster.

|org.uberfire.nio.git.ssh.host
|nodeOne
|The name of the SSH host machine in a physical cluster.
|===
endif::DM[]
+
ifdef::PAM[]
The following examples demonstrate how to configure a three node cluster in the `host.xml` file:
+
.Cluster nodeOne Configuration COMMENT: Should I remove all of the 'boot-time="false"?'
====
[source,xml]
----
<system-properties>
 <property name="org.uberfire.nio.git.dir" value="/tmp/rhpam/nodeone"
           boot-time="false"/>
 <property name="jboss.node.name" value="nodeOne"/>
 <property name="org.uberfire.cluster.id" value="rhpam-cluster" boot-time="false"/>
 <property name="org.uberfire.cluster.local.id" value="nodeOne_12345"
           boot-time="false"/>
 <property name="org.uberfire.cluster.vfs.lock" value="vfs-repo" boot-time="false"/>
 <property name="org.uberfire.nio.git.daemon.host" value="nodeOne"/>
 <property name="org.uberfire.nio.git.daemon.port" value="9418" boot-time="false"/>
 <property name="org.uberfire.nio.git.daemon.hostport" value="9418"
           boot-time="false"/>
 <property name="org.uberfire.nio.git.ssh.port" value="8003" boot-time="false"/>
 <property name="org.uberfire.nio.git.ssh.hostport" value="8003" boot-time="false"/>
 <property name="org.uberfire.nio.git.ssh.host" value="nodeOne"/>
 <property name="org.uberfire.metadata.index.dir" value="/tmp/jbpm/nodeone"
           boot-time="false"/>
 <property name="org.uberfire.nio.git.ssh.cert.dir" value="/tmp/jbpm/nodeone"
           boot-time="false"/>
</system-properties>
----
====
endif::PAM[]
+
ifdef::PAM[]

.Cluster nodeTwo Configuration
====
[source,xml]
----
<system-properties>
 <property name="org.uberfire.nio.git.dir" value="/tmp/rhpam/nodetwo"
           boot-time="false"/>
 <property name="jboss.node.name" value="nodeTwo" boot-time="false"/>
 <property name="org.uberfire.cluster.id" value="rhpam-cluster" boot-time="false"/>
 <property name="org.uberfire.cluster.local.id" value="nodeTwo_12346"
           boot-time="false"/>
 <property name="org.uberfire.cluster.vfs.lock" value="vfs-repo" boot-time="false"/>
 <property name="org.uberfire.nio.git.daemon.host" value="nodeTwo" />
 <property name="org.uberfire.nio.git.daemon.port" value="9419" boot-time="false"/>
 <property name="org.uberfire.nio.git.daemon.hostport" value="9419"
           boot-time="false"/>
 <property name="org.uberfire.nio.git.ssh.port" value="8004" boot-time="false"/>
 <property name="org.uberfire.nio.git.ssh.hostport" value="8004" boot-time="false"/>
 <property name="org.uberfire.nio.git.ssh.host" value="nodeTwo" />
 <property name="org.uberfire.metadata.index.dir" value="/tmp/jbpm/nodetwo"
           boot-time="false"/>
 <property name="org.uberfire.nio.git.ssh.cert.dir" value="/tmp/jbpm/nodetwo"
           boot-time="false"/>
</system-properties>
----
====
endif::PAM[]
+
ifdef::PAM[]

.Cluster nodeThree Configuration
====
[source,xml]
----
<system-properties>
 <property name="org.uberfire.nio.git.dir" value="/tmp/rhpam/nodethree"
           boot-time="false"/>
 <property name="jboss.node.name" value="nodeThree" boot-time="false"/>
 <property name="org.uberfire.cluster.id" value="rhpam-cluster" boot-time="false"/>
 <property name="org.uberfire.cluster.local.id" value="nodeThree_12347"
           boot-time="false"/>
 <property name="org.uberfire.cluster.vfs.lock" value="vfs-repo" boot-time="false"/>
 <property name="org.uberfire.nio.git.daemon.host" value="nodeThree" />
 <property name="org.uberfire.nio.git.daemon.port" value="9420" boot-time="false"/>
 <property name="org.uberfire.nio.git.daemon.hostport" value="9420"
           boot-time="false"/>
 <property name="org.uberfire.nio.git.ssh.port" value="8005" boot-time="false"/>
 <property name="org.uberfire.nio.git.ssh.hostport" value="8005" boot-time="false"/>
 <property name="org.uberfire.nio.git.ssh.host" value="nodeThree" />
 <property name="org.uberfire.metadata.index.dir" value="/tmp/jbpm/nodethree"
           boot-time="false"/>
 <property name="org.uberfire.nio.git.ssh.cert.dir" value="/tmp/jbpm/nodethree"
           boot-time="false"/>
</system-properties>
----
====
endif::PAM[]
ifdef::DM[]

.Cluster nodeOne Configuration
====
[source,xml]
----
<system-properties>
 <property name="org.uberfire.nio.git.dir" value="/tmp/brms/nodeone"
           boot-time="false"/>
 <property name="jboss.node.name" value="nodeOne" boot-time="false"/>
 <property name="org.uberfire.cluster.id" value="brms-cluster" boot-time="false"/>
 <property name="org.uberfire.cluster.local.id" value="nodeOne_12345"
           boot-time="false"/>
 <property name="org.uberfire.cluster.vfs.lock" value="vfs-repo" boot-time="false"/>
 <property name="org.uberfire.nio.git.daemon.port" value="9418" boot-time="false"/>
 <property name="org.uberfire.metadata.index.dir" value="/tmp/jbrm/nodeone"
           boot-time="false"/>
 <property name="org.uberfire.nio.git.ssh.cert.dir" value="/tmp/jbpm/nodeone"
           boot-time="false"/>
 <property name="org.uberfire.nio.git.ssh.port" value="8003" boot-time="false"/>
 <property name="org.uberfire.nio.git.daemon.host" value="nodeOne" />
 <property name="org.uberfire.nio.git.ssh.host" value="nodeOne" />
 <property name="org.uberfire.nio.git.ssh.hostport" value="8003" boot-time="false"/>
 <property name="org.uberfire.nio.git.daemon.hostport" value="9418"
           boot-time="false"/>
</system-properties>
----
====
endif::DM[]
+
ifdef::DM[]

.Cluster nodeTwo Configuration
====
[source,xml]
----
<system-properties>
 <property name="org.uberfire.nio.git.dir" value="/tmp/brms/nodetwo"
           boot-time="false"/>
 <property name="jboss.node.name" value="nodeTwo" boot-time="false"/>
 <property name="org.uberfire.cluster.id" value="brms-cluster" boot-time="false"/>
 <property name="org.uberfire.cluster.local.id" value="nodeTwo_12346"
           boot-time="false"/>
 <property name="org.uberfire.cluster.vfs.lock" value="vfs-repo" boot-time="false"/>
 <property name="org.uberfire.nio.git.daemon.port" value="9418" boot-time="false"/>
 <property name="org.uberfire.metadata.index.dir" value="/tmp/jbrm/nodetwo"
           boot-time="false"/>
 <property name="org.uberfire.nio.git.ssh.cert.dir" value="/tmp/jbpm/nodetwo"
           boot-time="false"/>
 <property name="org.uberfire.nio.git.ssh.port" value="8003" boot-time="false"/>
 <property name="org.uberfire.nio.git.daemon.host" value="nodeTwo" />
 <property name="org.uberfire.nio.git.ssh.host" value="nodeTwo" />
 <property name="org.uberfire.nio.git.ssh.hostport" value="8003" boot-time="false"/>
 <property name="org.uberfire.nio.git.daemon.hostport" value="9418"
           boot-time="false"/>
</system-properties>
----
====
endif::DM[]
+
ifdef::DM[]

.Cluster nodeThree Configuration
====
[source,xml]
----
<system-properties>
 <property name="org.uberfire.nio.git.dir" value="/tmp/brms/nodethree"
           boot-time="false"/>
 <property name="jboss.node.name" value="nodeThree" boot-time="false"/>
 <property name="org.uberfire.cluster.id" value="brms-cluster" boot-time="false"/>
 <property name="org.uberfire.cluster.local.id" value="nodeThree_12347"
           boot-time="false"/>
 <property name="org.uberfire.cluster.vfs.lock" value="vfs-repo" boot-time="false"/>
 <property name="org.uberfire.nio.git.daemon.port" value="9418" boot-time="false"/>
 <property name="org.uberfire.metadata.index.dir" value="/tmp/jbrm/nodethree"
           boot-time="false"/>
 <property name="org.uberfire.nio.git.ssh.cert.dir" value="/tmp/jbpm/nodethree"
           boot-time="false"/>
 <property name="org.uberfire.nio.git.ssh.port" value="8003" boot-time="false"/>
 <property name="org.uberfire.nio.git.daemon.host" value="nodeThree" />
 <property name="org.uberfire.nio.git.ssh.host" value="nodeThree" />
 <property name="org.uberfire.nio.git.ssh.hostport" value="8003" boot-time="false"/>
 <property name="org.uberfire.nio.git.daemon.hostport" value="9418"
           boot-time="false"/>
</system-properties>
----
====
endif::DM[]

