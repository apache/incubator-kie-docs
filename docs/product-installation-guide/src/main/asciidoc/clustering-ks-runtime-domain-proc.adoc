[id='clustering-ks-runtime-domain-proc']
= Clustering {KIE_SERVER} for a runtime environment
In a runtime environment, {KIE_SERVER} runs rules and processes that support business decisions. The primary benefit of clustering a {KIE_SERVER} runtime environment is load balancing. If activity on one node of the cluster increases, that activity can be shared among the other nodes of the cluster to improve performance.

.Procedure
. Download and install {EAP}:
.. Navigate to the https://access.redhat.com/jbossnetwork/restricted/listSoftware.html[Software Downloads] page in the Red Hat Customer Portal (login required) and select the product and version from the drop-down options:
* *Product: Enterprise Application Platform*
* *Version: 7.1*
.. Click *Download* next to *Red Hat JBoss Enterprise Application Platform 7.1.0*. (`jboss-eap-7.1.0.zip`).
.. Extract the `jboss-eap-7.1.0.zip` file. The `jboss-eap-7.1/jboss-eap-7.1` directory is referred to as `_EAP_HOME_`.

. Download and extract {KIE_SERVER}:
.. Navigate to the https://access.redhat.com/jbossnetwork/restricted/listSoftware.html[Software Downloads] page in the Red Hat Customer Portal and select the product and version from the drop-down options:
* *Product: {PRODUCT}*
* *Version: {PRODUCT_VERSION}*
* Download  *{PRODUCT} 7.0.0 {KIE_SERVER} for All Supported EE7 Containers*
ifdef::PAM[]
(`{PRODUCT_FILE}-kie-server-ee7.zip`).
endif::PAM[]
ifdef::DM[]
(`{PRODUCT_FILE}-kie-server-ee7.zip`).
endif::DM[]
ifdef::PAM[]
+
.. Extract the 
ifdef::PAM[]
`{PRODUCT_FILE}-kie-server-ee7.zip`
endif::PAM[]
ifdef::DM[]
`{PRODUCT_FILE}-kie-server-ee7.zip`
endif::DM[]
 archive to a temporary directory. In the following examples this directory is called `_TEMP_DIR_`.
. Repackage the `kie-server.war` directory:
.. Navigate to the `_TEMP_DIR_/{PRODUCT_FILE}-kie-server-ee7/kie-server.war` directory.
.. Select the contents of the  `_TEMP_DIR_/{PRODUCT_FILE}-kie-server-ee7/kie-server.war` directory and create the `kie-server.zip` file.
..  Rename `kie-server.zip` to `kie-server.war`. This is the file that you will use to deploy {KIE_SERVER} on the cluster nodes.
.. If desired, copy the new `kie-server.war` file to a location that is more convenient to deploy from.

. If you want to use a security manager for {KIE_SERVER}, repackage the `SecurityPolicy` directory:
.. Navigate to the `_TEMP_DIR_/{PRODUCT_FILE}-kie-server-ee7/SecurityPolicy/`
directory.
.. Select the contents of the  `_TEMP_DIR_/{PRODUCT_FILE}-kie-server-ee7/SecurityPolicy/` directory and create the `SecurityPolicy.zip` file.
..  Rename `SecurityPolicy.zip` to `SecurityPolicy.war`. This is the file that you will use to deploy the security policy on the cluster nodes.
.. If desired, copy the new `SecurityPolicy.war` file to a location that is more convenient to deploy from.

. Add {EAP} management users as described in the https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.1/html-single/configuration_guide/[_{EAP} 7.1 Configuration Guide_] and {KIE_SERVER} users as described in {URL_INSTALLING_ON_EAP}[_{INSTALLING_ON_EAP}_]. To access {KIE_SERVER}, the user must have the `kie-server` role. Add the `admin` role to the {KIE_SERVER} user to access {CENTRAL} as well.
. Install the JDBC driver on all {EAP} instances that are part of this cluster. For more information, see the https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.1/html-single/configuration_guide/#jdbc_drivers["JDBC Drivers"] section of the _{EAP} 7.1 Configuration Guide_.
. Edit the `_EAP_HOME_/_MODE_/configuration/domain.xml` file.
.. Edit the `data-stores` property and the `timer-service thread-pool-name` above it. The `datasource-jndi-name` is the JNDI name of the database specified in the previous step. You can enter any name for the value of the `partition` property. Replace `"default-file-store"` with `"ejb_timer-ds"`Â· Set the value of `refresh-interval` to specify how often the EJB timer connects to the database to synchronize and load tasks to be processed:
+
[source,xml]
----
<timer-service thread-pool-name="default" default-data-store="ejb-timer-ds">
<data-stores>      
    <database-data-store name="ejb_timer_ds" datasource-jndi-name="java:jboss/datasources/ejb_timer" database="postgresql" partition="ejb_timer_part" refresh-interval="30000"/>       
</data-stores> 
----

.. Add the {KIE_SERVER} and EJB timer data sources to the `full` profile. In these examples,  `<SERVER_NAME>` is the host name of the JNDI database, and `<USER_NAME>` and `<USER_PWD>` are the credentials for that database.
ifdef::PAM[]
* Add the data source to allow {KIE_SERVER} to connect to the database, for example:
+
[source,xml]
----
<xa-datasource jndi-name="java:/jboss/datasources/rhpam" pool-name="rhpam-RHPAM" use-java-context="true" enabled="true"> 
  <xa-datasource-property name="DatabaseName"><DATABASE></xa-datasource-property>"
  <xa-datasource-property name="PortNumber">5432</xa-datasource-property> 
  <xa-datasource-property name="ServerName"><SERVER_NAME></xa-datasource-property> 
  <driver>postgresql</driver>  
  <security>
    <user-name><USER_NAME></user-name> 
    <password><USER_PWD></password> 
</security> 
</xa-datasource>
----
* Add the data source to enable the EJB timer, for example:
+
[source,xml]
----
<xa-datasource jndi-name="java:jboss/datasources/ejb_timer" pool-name="ejb_timer" use-java-context="true" enabled="true">
    <xa-datasource-property name="DatabaseName"><DATABASE></xa-datasource-property> 
    <xa-datasource-property name="PortNumber">5432</xa-datasource-property> 
    <xa-datasource-property name="ServerName"><SERVER_NAME></xa-datasource-property> 
    <driver>postgresql</driver>
    <transaction-isolation>TRANSACTION_READ_COMMITTED</transaction-isolation> 
    <xa-pool> 
        <min-pool-size>10</min-pool-size> 
        <max-pool-size>10</max-pool-size>
    </xa-pool>   
    <security> 
        <user-name><USER_NAME></user-name> 
        <password><USER_PWD></password> 
    </security> 
</xa-datasource>
----
endif::PAM[]
.. In the `security-setting` element of the `activemq` subsystem in the `"full"` profile, add the `kie-server` and `admin` roles:
+
[source]
----
<subsystem xmlns="urn:jboss:domain:messaging-activemq:2.0">
    <server name="default">
        <security-setting name="#">
            <role name="guest" send="true" consume="true" create-non-durable-queue="true" delete-non-durable-queue="true"/>
            <role name="kie-server" send="true" consume="true" create-non-durable-queue="true" delete-non-durable-queue="true"/>
        </security-setting>
---- 
.. Add the following properties to the `<system-properties>` element:
+
* `org.kie.server.persistence.ds`: The JNDI name of your data source. For {PRODUCT}, this is `java:/jboss/datasources/rhpam`
* `org.kie.server.persistence.dialect`: The hibernate dialect for your database
+
The following dialects are supported:
+ 
* DB2: `org.hibernate.dialect.DB2Dialect`
* MSSQL: `org.hibernate.dialect.SQLServer2012Dialect`
* MySQL: `org.hibernate.dialect.MySQL5InnoDBDialect`
* MariaDB: `org.hibernate.dialect.MySQL5InnoDBDialect`
* Oracle: `org.hibernate.dialect.Oracle10gDialect`
* PostgreSQL: `org.hibernate.dialect.PostgreSQL82Dialect`
* PostgreSQL plus: `org.hibernate.dialect.PostgresPlusDialect`
* Sybase: `org.hibernate.dialect.SybaseASE157Dialect`

. To deploy the `kie-server.war` file that you created previously into the server group, complete the following steps:
.. Log in to the {EAP} `Administration` console of your domain as a `management` user.
.. Click *Deployments -> Server Groups-> main-server-group* and click *Add*.
.. In the dialog box, click *Upload a new deployment* and click *Next*.
.. In the *Upload Deployments* dialog box, click *Browse*, select the `kie-server.war` file, and click *Next*.
.. Click *Enable* and  click *Next*.
+
[NOTE]
====
Make sure to check deployment unit readiness with every cluster member.

When a deployment unit is created on a cluster node, it takes some time before it is distributed among all cluster members. You can check the deployment status using the server Administration console or REST API. However, if the query is sent to the node where the deployment was originally issued, the query will return a value of `deployed`. If the query is sent to a node where the deployment has not yet been distributed, the query returns `DeploymentNotFoundException`.
====

For more information about installing {CENTRAL}, see  {URL_INSTALLING_ON_EAP}[_{INSTALLING_ON_EAP}_].


